import pandas as pd
import numpy  as np
import buildSegmentsAndIntervals as bsi

maximaExcursion = 0

bitDeSigno = 1
bitsDeSegmento = 1
bitsDeIntervalo = 3
valorDeAcopio = 0.0
dictTamSegmento = {}
dictTamIntervalo = {}

maximaExcursion, bitsDeSegmento, dictTamSegmento, bitsDeIntervalo, dictTamIntervalo, valorDeAcopio = bsi.obtainForm()
bitsCodificacion = bitDeSigno + bitsDeIntervalo + bitsDeSegmento
arraySegmento, dictIntervalo  = bsi.recursiveFun(dictTamSegmento)

df_segmentos = pd.DataFrame(arraySegmento).T
df_blanco = pd.DataFrame([" "]).T
df_intervalos = pd.DataFrame(dictIntervalo).T
df_info = pd.DataFrame(["valorDeAcopio", valorDeAcopio, "Max Excursion", maximaExcursion, "bitsCodificacion", bitsCodificacion, "bitsDeSegmento", bitsDeSegmento, "bitsDeIntervalo", bitsDeIntervalo]).T

df = pd.concat([df_segmentos, df_blanco, df_intervalos, df_blanco, df_info], sort= False)
df.to_excel(excel_writer = "./codificador_prueba.xlsx")

#chain = "3.2174479156,6.3437499987,-2.1542968741,1.1608072912,-4.0976562489,-0.7506510414,3.9531249989,15.2526041644,-23.1276041637,6.1197916654,15.1145833311,-10.8489583315,-12.3541666647,-13.3463541646,-7.9374999985,-8.4713541651,25.7942708301,-6.4518229153,-2.3151041657,-1.0976562496,19.2786458307,-26.1901041633,12.1718749981,14.4192708312,-0.8854166663,3.4518229156,0.6757812497,-21.8932291638,-4.0351562489,-26.1979166633,0.1302083333,10.041666665,-18.4765624975,6.7018229153,15.864583331,5.3958333321,4.0559895822,-17.3359374976,0.8033854163,10.143229165,-3.066406249,6.1197916654,2.2792968741,-5.2994791654,-1.5019531244,10.1718749983,0.3463541665,1.5065104161,3.2096354156,6.1197916654,26.5937499966,-1.1289062495,-1.5019531244,-8.9127604151,9.963541665,12.5885416647,-21.1302083305,1.3509114578,2.3203124991,-21.3489583305,-12.3567708314,-0.0266927083,-5.919270832,-8.4739583318,-20.127604164,-6.1197916654,2.515624999,-5.0859374988,-0.6009114581,4.8450520821,5.9401041654,15.2630208311,-0.8658854163,-6.1197916654,2.4322916657,-5.2786458321,-1.5019531244,-18.0130208308,10.4999999983,8.8190104151,-23.1432291637,7.1979166652,-15.919270831,-10.5156249982,-12.3411458314,2.3046874991,0.1367187499,15.973958331,-18.8098958308,-5.950520832,-14.5338541645,1.0533854162,-0.5644531248,4.9687499988,7.0260416653,2.0631510408,-3.0677083323,-7.4518229152,-14.4505208312,10.7239583316,-9.3476562484,-3.167968749,1.8098958326,19.9296874973,-23.124999997,1.8385416659,-0.2174479166,-5.4453124988,-12.3411458314,-4.9075520821,12.2604166647,10.041666665,-18.1249999975,6.032552082,-15.5312499977,-5.3984374988,-0.5384114581,-10.2356770816,1.7239583326,-1.731119791,-22.1406249971,7.0364583319,2.1126302075,10.5156249982,-12.3411458314,-18.0130208308,10.4999999983,17.2526041642,-21.1249999972,5.8697916654,2.0299479159,-18.3333333308,4.0455729156,-4.8958333321,0.1471354166,20.5963541639,-3.070312499,7.4531249986,2.2070312491,-18.3489583308,-13.9609374979,-0.2819010416,0.3749999998,9.4817708317,-24.1588541636,-1.9179687492,1.5266927077,-3.210937499,-4.6796874988,-10.2408854149,1.4648437494,17.2630208309,-21.7968749971,-6.118489582,2.0709635408,-5.0234374988,-1.5110677077,-0.2688802082,9.940104165,19.9192708306,-3.0065104157,-6.118489582,-0.6751302081,5.4453124988,19.0911458307,-25.3359374968,0.4752604165,10.1484374983,-20.127604164,5.7851562487,2.3170572907,-17.4348958309,-6.720052082,-0.2558593749,0.6471354164,8.7083333318,-18.8098958308,-1.3515624995,14.4505208312,10.6432291649,-4.0533854156,-0.2610677082,1.7083333326,-1.7343749993,20.1484374973,-6.9492187486,-15.919270831,-10.8489583315,-1.5019531244,3.5481770823,1.8151041659,18.5859374974,-3.0651041657,-6.0937499987,-1.4042968744,21.5390624971,-6.813802082,-22.4401041637,-8.5963541651,18.6223958308,-3.0651041657,7.2877604152,-2.1067708325,-1.0774739579,-4.0143229156,-22.6692708304,8.6302083318,12.6197916647,-18.1354166642,7.0338541653,-15.6015624977,-8.5442708318,-3.7226562489,-17.3359374976,9.9296874983,23.0833333303,-21.8098958305,1.3496093745,-15.927083331,-1.2018229162,24.3828124969,-4.9283854155,0.4765624998,16.4218749977,-5.0065104155,-4.5325520822,-15.9531249977,5.1119791655,19.0234374974,-17.3359374976,18.4999999975,14.6223958312,-23.374999997,-7.1210937486,-14.7604166645,-1.2024739579,-13.7994791646,1.5970052077,7.0833333319,-1.709635416,-18.8098958308,-6.0338541654,-14.6145833312,5.2942708321,-0.6009114581,4.5013020822,8.5859374984,19.2734374974,23.476562497,-1.9179687492,1.5266927077,-4.5208333322,3.7122395823,-4.8958333321,0.1028645833,18.6067708308,-21.8098958305,5.9518229154,9.682291665,5.2526041654,-0.5175781248,-0.9720052079,1.1315104162,-8.3463541651,-23.4635416636,1.3489583328,15.6171874977,1.1393229162,-1.5019531244,-3.5260416656,0.1302083333,10.1497395816,-22.4765624971,6.5351562486,15.934895831,-17.4322916642,-9.3867187484,-0.3001302082,0.4765624998,11.2968749982,-18.7083333308,-7.7604166652,-2.2584635408,1.0143229163,19.424479164,-25.3359374968,13.5729166646,-8.4817708318,21.4765624972,1.3346354161,2.4739583324,3.6744791656,13.8619791646,1.5859374994,0.1263020833,14.6145833312,21.3749999972,-5.9518229154,15.8697916644,-10.5598958316,-3.4791666656,-12.3880208314,7.0833333319,0.4798177081,-23.1276041637,-7.4518229152,-2.0234374992,-1.1497395829,23.007812497,2.2532552074,0.798177083,15.7499999977,-0.868489583,-5.7864583321,9.682291665,-5.2578124988,13.6953124979,2.0839843742,7.2734374986,-8.4739583318,-22.1484374971,1.3509114578,15.2005208311,21.7968749971,8.4414062485,2.2734374991,0.1263020833,9.8085937483,-20.1484374973,-5.7812499987,15.1614583311,-21.5885416638,-0.5787760414,-0.2636718749,10.9166666649,8.8098958318,-23.8098958303,1.3346354161,2.4739583324,5.3007812488,-9.4309895817,1.4173177078,7.7499999985,17.2526041642,-18.4635416641,5.9492187487,-15.8463541644,8.5468749984,1.7812499993,-12.3437499981,0.1445312499,18.6067708308,-21.1406249972,-5.7864583321,9.682291665,1.0559895829,8.6692708318,-2.2532552074,9.940104165,9.1315104151,-0.8671874997,-5.7851562487,-14.5364583312,-10.7239583316,-13.9661458312,3.5781249989,0.1523437499,15.7499999977,-22.4843749971,6.114583332,2.2584635408,18.3333333308,4.1289062489,4.8502604155,3.2526041656,-14.3593749979,-19.8098958307,7.2031249986,2.3216145824,-10.5598958316,-6.0039062487,0.2975260415,1.7994791659,12.6302083314,-20.1302083306,6.8658854153,-2.3131510407,-10.3802083316,-0.5878906248,-10.2617187483,2.1367187491,9.7929687483,-3.074218749,5.7851562487,-2.5572916657,0.4791666665,4.6796874988,-26.08333333,5.7499999987,19.6171874973,-3.187499999,-3.3658854156,-9.6770833317,-21.0598958305,-4.2122395822,-0.9355468746,1.8098958326,8.7083333318,-0.868489583,-5.7604166654,-2.0286458325,-10.9322916649,-13.8203124979,-0.925130208,4.2994791655,15.7499999977,-18.8151041641,1.3509114578,-16.114583331,-21.3489583305,-1.5624999994,-12.9270833313,0.1315104166,19.2578124974,-22.1406249971,5.8697916654,2.3216145824,-18.3489583308,-9.3867187484,-0.2819010416,0.3749999998,15.3046874978,-18.8151041641,-7.3658854152,-9.6679687483,-10.5156249982,-14.0703124979,0.2975260415,1.7955729159,12.585937498,-3.074218749,7.4270833319,-2.6002604157,-5.3841145821,-9.5559895817,-3.2395833323,-4.4166666655,5.0130208321,-9.0651041651,1.3437499995,2.3222656241,-5.0286458321,-8.0117187485,-0.2636718749,7.0833333319,14.6223958312,-23.374999997,-5.9479166654,-15.4531249978,-1.1608072912,-5.9999999987,-12.7213541647,5.7499999987,11.2630208315,-21.8020833305,6.9270833319,-2.0911458325,3.6744791656,9.3450520817,-0.2688802082,5.9557291654,18.6067708308,-17.3463541642,-5.9518229154,15.5104166644,-1.0351562496,-1.8561197909,-0.7506510414,1.8164062493,17.2734374976,-19.4583333307,1.3522135411,-15.5104166644,-1.0924479162,1.9290364576,-26.05208333,0.0130208333,12.6197916647,-24.4687499969,5.954427082,-2.3151041657,-1.0351562496,24.7161458302,-26.15364583,10.5729166649,-1.7207031243,-22.1406249971,-6.0312499987,-14.7005208312,21.7968749971,-0.6009114581,-10.2395833316,0.1289062499,16.630208331,-17.4921874976,-5.7604166654,-0.2161458332,21.0572916639,19.0286458307,1.6230468744,7.0833333319,14.5859374978,-3.0768229157,-6.4479166653,16.0338541644,21.7656249971,1.8391927076,14.4401041645,10.9427083315,-8.4869791651,-17.4817708309,-6.9518229153,2.1959635408,0.3372395832,-1.8977864576,-10.1940104149,7.3020833319,16.4166666643,-0.8658854163,-6.0937499987,-2.1132812492,-21.1432291639,-13.7578124979,-25.3359374968,5.9296874987,19.0833333307,-23.468749997,7.2044270819,2.2070312491,-18.9166666641,3.335937499,6.0468749987,-4.5052083322,16.614583331,21.4869791638,-5.7864583321,0.6744791664,-21.7682291638,-14.2161458312,-0.7506510414,1.8072916659,-8.4179687485,-21.7968749971,-6.0859374987,2.3932291657,5.1067708321,-0.5957031248,-10.1940104149,2.585937499,-8.4635416651,-22.1484374971,1.3509114578,14.6588541645,-5.0286458321,19.3203124974,2.1536458325,-4.5963541655,19.291666664,-17.4635416642,-5.7864583321,9.682291665,-21.8906249971,-1.8964843742,-0.2584635416,1.8098958326,19.9296874973,-21.1406249972,-5.7864583321,9.6679687483,-10.6015624982,-13.9244791646,-7.6106770819,9.9192708316,15.7499999977,-18.8098958308,-1.3450520828,2.558593749,16.223958331,17.9583333308,-12.3671874981,1.8098958326,19.9192708306,-24.1484374969,-6.9531249986,9.6835937483,-5.2994791654,-9.4934895817,-20.6796874972,0.8072916663,10.1497395816,-3.0065104157,-6.032552082,-15.9479166644,-21.3906249972,-13.9661458312,-3.5273437489,7.0833333319,8.7083333318,-21.1432291639,7.2604166652,-1.5917968744,1.0143229163,19.3203124974,2.1145833325,-4.6484374988,-8.4648437485,-21.4791666638,-6.4492187487,-16.5312499976,-3.6744791656,-1.5019531244,0.2975260415,1.8164062493,10.143229165,-23.8020833303,7.2031249986,14.7604166645,-0.1080729166,-9.3867187484,-0.2819010416,0.3749999998,10.1458333316,-22.1458333304,-6.122395832,-14.4270833312,-1.0559895829,8.6705729151,-6.2148437487,7.1197916653,-1.7226562493,-9.8802083316,0.4290364582,-2.0234374992,-1.2128906245,-4.1601562489,-20.8359374972,0.3749999998,21.2734374972,-18.1510416642,-6.9531249986,2.1959635408,21.8072916638,-1.4999999994,-12.7213541647,7.0833333319,0.2454427082,-17.4609374976,7.4479166652,15.0338541645,18.3515624975,-9.5247395817,4.8606770821,7.2526041652,-24.3593749969,-25.3749999968,-6.118489582,0.6744791664,-21.0572916639,-9.3450520817,-0.3027343749,9.940104165,20.6197916639,-19.1432291641,1.3489583328,15.864583331,5.0703124988,-12.3333333314,-12.867187498,13.1666666647,10.6223958316,-23.140624997,6.4492187487,-2.0286458325,-10.8489583315,-12.3411458314,2.2897135408,7.1197916653,-1.711588541,-21.7083333305,-7.2877604152,-9.682291665,5.5091145821,-0.5071614581,-23.5338541636,3.9739583322,16.4166666643,-18.8072916641,7.0377604153,-15.1979166644,3.6666666656,4.1289062489,-0.7506510414,5.9401041654,9.1315104151,-23.1510416637,-5.7825520821,-0.6757812497,-21.2135416638,-0.5279947915,2.3027343741,9.9296874983,15.919270831,-5.0065104155,-6.032552082,-15.3437499978,-1.0351562496,1.8613281243,-18.1562499975,0.1263020833,15.2630208311,-23.1354166637,5.9479166654,-15.5338541644,18.3333333308,4.0664062489,-26.1901041633,6.5859374986,15.927083331,-22.0416666638,-7.4518229152,0.6757812497,-1.0143229163,-4.0559895822,-18.1328124975,10.9062499982,-15.6927083311,-13.7604166646,3.7734374989,-8.7617187484,1.0117187496,-0.4498697915,-10.2617187483,2.5963541657,15.7499999977,-23.484374997,7.2604166652,-2.0703124992,-5.0494791655,-13.9244791646,-18.1588541642,10.4999999983,-1.7298177076,-23.148437497,-5.7851562487,2.0703124992,-3.6744791656,-13.9609374979,-0.2532552082,2.6223958324,16.2838541643,-17.3463541642,-7.7604166652,-2.0911458325,3.6757812489,-6.8867187486,-0.2532552082,6.622395832,18.4166666641,-24.4687499969,7.4492187486,-2.0234374992,-0.1080729166,9.4934895817,2.0839843742,1.1523437495,10.1406249983,-19.4583333307,1.3496093745,-2.1126302075,0.3372395832,-6.7643229153,0.2988281249,3.9661458322,-15.6927083311,-10.4583333316,6.782552082,-15.5364583311,1.0117187496,-0.6009114581,4.5013020822,1.8164062493,17.2630208309,-23.124999997,6.8723958319,2.0234374992,-0.1087239583,-1.9446614576,-4.5013020822,1.1523437495,9.1484374984,-18.7083333308,-6.7018229153,15.9479166644,-3.6744791656,-19.393229164,-20.6770833306,5.6927083321,17.2630208309,-23.1432291637,1.3496093745,15.3671874978,21.7656249971,1.9134114576,2.2890624991,0.1445312499,18.6015624974,-24.1406249969,-6.7018229153,9.6679687483,-10.4739583316,1.9290364576,-2.3053385407,7.2604166652,8.7083333318,-23.484374997,1.3489583328,-15.3645833311,-10.3802083316,-0.6061197914,-4.9687499988,7.0260416653,1.557291666,-0.8580729163,-5.7604166654,-2.3489583324,-5.4257812488,-4.0976562489,-0.7506510414,0.4837239581,15.0833333311,-23.4635416636,1.3496093745,2.3216145824,-10.8906249982,-1.5624999994,-12.8776041647,1.8151041659,15.2890624978,-22.4687499971,6.6979166653,-15.927083331,-1.0253906246,-4.1601562489,3.5065104156,7.2604166652,16.4869791643,-0.8652343747,6.9518229153,2.4765624991,1.0559895829,9.3476562484,-2.2753906241,10.9062499982,-8.4635416651,-18.7083333308,-5.993489582,-14.6171874978,1.1608072912,-0.5279947915,2.0833333325,-4.6328124988,20.4166666639,-21.8098958305,5.950520832,-2.1067708325,-1.0976562496,9.5559895817,-20.7630208306,7.6328124985,-15.6927083311,-10.4583333316,1.3496093745,2.2584635408,21.7552083305,-0.5279947915,2.3027343741,9.9296874983,15.2630208311,-18.1354166642,6.0312499987,-10.1718749983,-0.1080729166,13.9869791646,1.6360677077,0.4739583331,-8.4648437485,-21.0416666639,-7.5338541652,-14.7838541645,11.1822916648,23.007812497,-8.8398437484,5.9479166654,8.8098958318,-18.4765624975,1.8346354159,2.0911458325,5.0494791655,-1.8873697909,-25.3359374968,5.9557291654,19.0833333307,-21.1249999972,7.4531249986,2.1126302075,1.0566406246,-5.9999999987,-12.867187498,1.8007812493,20.6302083306,-20.1302083306,-5.7825520821,-0.6744791664,-11.2265624982,-6.7070312486,2.1197916658,-4.4166666655,5.6796874987,-10.7916666649,7.2604166652,-2.3001302074,18.3489583308,-14.0651041646,-0.2584635416,7.9505208318,17.2812499976,-18.8177083308,-5.7604166654,-0.2161458332,21.5156249971,24.7161458302,-10.1718749983,0.1536458333,10.143229165,-18.1302083308,7.1770833319,-2.1126302075,9.0078124984,9.3450520817,-0.2558593749,0.4843749998,8.8072916651,-21.1249999972,1.8346354159,2.3932291657,5.1067708321,-0.5279947915,-17.3359374976,0.8151041663,8.8255208318,-22.0416666638,-7.1210937486,-14.7604166645,-1.0351562496,24.6119791635,-1.586588541,12.1927083314,-8.3463541651,-21.1432291639,1.3489583328,-15.5338541644,-5.2786458321,-1.5019531244,-18.0104166642,0.1536458333,10.1484374983,-18.4583333308,6.0143229154,0.2141927082,1.0117187496,-0.5488281248,-23.3776041636,1.8124999993,10.143229165,-18.4635416641,6.8645833319,15.1145833311,-3.6757812489,-6.8268229153,-18.0104166642,0.0130208333,8.8072916651,-3.066406249,7.1979166652,-15.5104166644,-1.0351562496,9.3476562484,-20.8255208306,9.7499999983,15.9557291644,-3.062499999,5.9479166654,-15.3671874978,1.0123697913,5.7747395821,2.2734374991,0.1315104166,14.4166666645,-23.476562497,6.677083332,-2.0292968742,1.2226562495,13.7161458313,1.5859374994,0.1263020833,-8.4843749985,-22.1302083304,-6.9531249986,10.1718749983,-0.1080729166,4.2226562489,2.3027343741,3.9244791656,12.585937498,-3.0651041657,7.2604166652,-2.2584635408,-5.0494791655,-14.0494791646,3.5065104156,1.3932291661,-1.6874999993,-14.4270833312,0.4277343748,-2.1126302075,0.3372395832,0.5800781248,-20.6901041639,9.9296874983,-8.4739583318,-22.1484374971,1.3496093745,-2.1132812492,-10.5572916649,-6.7539062486,-26.1979166633,-4.5364583322,8.8151041651,-20.3124999973,6.9270833319,-2.3515624991,-10.5572916649,-9.4309895817,-2.2532552074,7.2604166652,16.4479166643,-0.8658854163,6.677083332,-2.0292968742,1.1393229162,-1.5019531244,-3.5260416656,0.1406249999,8.7083333318,-21.1510416639,5.950520832,-2.0234374992,-0.107421875,-0.5957031248,-26.0703124967,3.9687499989,12.5911458314,-22.0416666638,-6.118489582,2.4739583324,8.0403645818,-6.145833332,-12.523437498,3.9244791656,8.8190104151,-23.1510416637,-6.0937499987,-2.1126302075,9.0065104151,-6.680989582,-22.6692708304,-6.5859374986,19.9296874973,-22.0130208304,-6.118489582,0.6848958331,-5.4244791654,24.6119791635,-26.1979166633,0.1536458333,16.614583331,-17.4765624976,-6.0351562487,10.1679687483,-9.0468749984,-9.389322915,-1.5970052077,9.7499999983,8.8098958318,-23.7968749969,7.2604166652,-2.3932291657,5.1067708321,-0.6165364581,-10.1888020816,0.3776041665,-14.4166666645,-0.8652343747,6.9518229153,0.6751302081,1.1289062495,-1.9029947909,-0.9661458329,0.1315104166,19.2578124974,-23.1354166637,5.8671874987,-26.58333333"

arrayOrder = ["Signo", "Segmento", "Intervalo"]

# Funcion que rellena los zeros faltantes en la ultima posicion
def putZerosBefore(chain, bits):
    zeros = ""
    for _ in range(len(chain), bits):
        zeros += "0"
    zeros += chain
    
    return zeros

# Funcion que borra los zeros de la ultima posicion
# Esto para limpiar la codificacion
def dropZerosAfter(chain):
    return chain[:chain.rfind('1')+1]

getBitSigno = lambda x: "0" if (str(x)[0] == "-") else "1"
convertIntToBin = lambda x: format(x, 'b')

def searchInArray(valueToSearhc, minPosition):
    if valueToSearhc >= arraySegmento[minPosition] and valueToSearhc < arraySegmento[minPosition + 1]:
        return minPosition
    
    return searchInArray(valueToSearhc, minPosition + 1)

def searchInMeta(requestValue : float):
    tempKey= 0.0
    lastValue = 0.0
    presentValue = 0.0
    for key, value in dictTamSegmento.items():
        floatKey = float(key)
        result = (floatKey - tempKey) * value
        presentValue += result

        if requestValue == 0:
            return 0, key
        
        elif requestValue >= lastValue and requestValue < presentValue:
            response = searchInArray(requestValue, int(tempKey))
            return response, key

        elif requestValue == 5.0:
            return len(arraySegmento) - 2, key

        lastValue = presentValue
        tempKey = floatKey

# Funcion que itera sobre los voltajes
def makeChain(arrayChain):
    volBinChain = ""
    arrayBins = []

    for volt in arrayChain:
        volBinChain = getBitSigno(volt)
        
        volt = abs(volt)

        intSegmento, keyIntervals = searchInMeta(volt)
        tempBinSegment = convertIntToBin(intSegmento)
        
        binSegment = putZerosBefore(tempBinSegment, bitsDeSegmento)

        volInterval = np.round(volt - arraySegmento[intSegmento], 10) # Restamos el tamaño del segmento por el voltaje y obtenemos el intervalo
        intInterval = int(round(abs(volInterval) / dictTamIntervalo[keyIntervals])) # Dividimos el voltaje restante entre el tamaño del intervalo
        tempBinInterval = convertIntToBin(intInterval)
        binInterval = putZerosBefore(tempBinInterval, bitsDeIntervalo)
        if arrayOrder[1] == "Segmento":
            volBinChain += (str(binSegment) + str(binInterval))
        elif arrayOrder[1] == "Intervalo":
            volBinChain += (str(binInterval) + str(binSegment))

        arrayBins.append(volBinChain)
        
    arrayBins[-1] = dropZerosAfter(arrayBins[-1])

    return arrayBins


def good_bye_world(chain):
    arrayVolts = chain.split(",")
    arrayChain = [float(value) for value in arrayVolts]

    response = str.join("", makeChain(arrayChain))
    print(bitsDeSegmento)
    #return response + " | " + responseAS + " | " + responseAI

    return response
